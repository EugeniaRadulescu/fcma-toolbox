<!DOCTYPE HTML>
<!--
/*
 * Full Correlation Matrix Analysis (FCMA) demo
 *   Ben Singer <bdsinger@princeton.edu>
 * 
 * based on jQuery Uploader by Sebastian Tschan
 * Copyright 2010, https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
-->
<html lang="en">
<head>
<!-- Force latest IE rendering engine or ChromeFrame if installed -->
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><![endif]-->
<meta charset="utf-8">
<title>Princeton FCMA Toolbox</title>
<meta name="description" content="The Princeton Full Correlation Matrix Analysis (FCMA) Toolbox is a suite of tools for correlating, analyzing, and classifying patterns of correlation in functional neuroimaging datasets.">
<meta name="viewport" content="width=device-width">
<!-- Bootstrap CSS Toolkit styles -->
<link rel="stylesheet" href="/fcma/css/bootstrap.min.css">
<!-- Generic page styles -->
<link rel="stylesheet" href="/fcma/css/style.css">
<!-- Bootstrap styles for responsive website layout, supporting different screen sizes -->
<link rel="stylesheet" href="/fcma/css/bootstrap-responsive.min.css">
<!-- Bootstrap CSS fixes for IE6 -->
<!--[if lt IE 7]><link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap-ie6.min.css"><![endif]-->
<!--[if lt IE 7]><link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap-ie6.min.css"><![endif]-->
<!-- Shim to make HTML5 elements usable in older Internet Explorer versions -->
<!--[if lt IE 9]><script src="js/html5.js"></script><![endif]-->
<link rel="stylesheet" href="/fcma/css/button.css">
<script type="text/javascript" src="dat.gui.js"></script>
<script type="text/javascript">

var base = '/gigatmp/scratch/me/project/';
var analysisList = [ '1 - Voxel selection', '2 - Test prediction accuracy' ];
var blocksList = [ 'Blocks directory', 'Blocks file' ];
var maskList = [ 'ROI Mask 1', 'ROI Mask 2', 'No masks', 'Both masks' ];
var classifierList = ['SVM performance', 'smart distance ratio', 'correlation sum'];
var controlWidth = 500;
var gui = new dat.GUI({ autoPlace: false, width: controlWidth});
var kFirstMask = 0, kSecondMask = 1, kNoMasks = 2, kBothMasks = 3;
var kSelectionIndex = 0, kTestingIndex = 1;
var kSelectionSVM_FCMA = 0, kSelectionSDR_FCMA = 1, kSelectionSearch_MVPA = 2, kSelectionCORRSUM_FCMA = 3, kTestingTask_FCMA = 4, kXValidateTask_FCMA = 5, kTestingTask_MVPA = 6, kXValidateTask_MVPA = 7;
var kNA = -1;

var createFCMA = function() {
	var blockIsDir = (params["blocksInput"] == 'Blocks directory');
	var maskChoice = maskList.indexOf(params["maskInput"]);
	var is_mvpa_control = params['mvpa_control'];
	var analysisChoice = analysisList.indexOf(params["analysisStage"]);
	var classifierChoice = classifierList.indexOf(params["classifier"]);
	var all_in = (params['num_items_held_for_test'] == 0);
	var num_processors = 8;
	if (analysisChoice == kSelectionIndex) {
		params['is_test_mode'] = 0;
		if (is_mvpa_control) {
			params['task_type'] = kSelectionSearch_MVPA;
		} else if (classifierChoice > 1) {
			params['task_type'] = kSelectionCORRSUM_FCMA;
		} else {
			params['task_type'] = kSelectionSVM_FCMA + classifierChoice;
		}
	} else {
		params['is_test_mode'] = 1;
		num_processors = 1;
		if (is_mvpa_control) {
            params['task_type'] = kTestingTask_MVPA;
		} else {
			params['task_type'] = kTestingTask_FCMA;
		}
		if (all_in == false) {
			params['task_type'] += 1;
		}
	}

	var res = '';
	for (var k in params) {
		if ( (k == 'analysisStage') || (k == 'blocksInput') || (k == 'maskInput') || (k == 'classifier') || (k == 'mvpa_control') ) {
			continue;
		}
		if ( (k == 'blockdir') && (blockIsDir !== true) ) {
			continue;			
		}
		if ( (k == 'blockfile' ) && (blockIsDir == true) ) {
			continue;
		}
		if ( (k == 'first_maskfile') && ((maskChoice == kSecondMask) || (maskChoice == kNoMasks)) ) {
			continue;
		}
		if ( (k == 'second_maskfile' ) && ((maskChoice == kFirstMask) || (maskChoice == kNoMasks)) ) {
			continue;
		}
		if ( (k == 'first_left_out_block_id') && (all_in) ) {
			res = res + k + ':-1\n';
			continue;
		}
		
		if (typeof params[k] !== 'function') {
         	res = res + k + ':' + params[k] + '\n';
        }
	}
	
	res = res + '\n';
	res = res + '# check w/sysadmin before changing anything below!\n';
	res = res + '# this is the only supported fMRI format\n';
	res = res + 'matrix_format:.nii.gz\n';
	res = res + '# these are rondo-specific\n';
	res = res + 'omp_num_threads:7\n';
	res = res + 'num_processors:'+num_processors+'\n';
	
	var ta = document.getElementById("fcma-out");
	ta.innerHTML = res;
};

var downloadFCMA = function() {
	var ta = document.getElementById("fcma-out");
	window.location = "data:application/octet-stream,"+encodeURIComponent(ta.innerHTML);
};

var params = {
  	analysisStage: analysisList[0],
  	maskInput: maskList[0],
  	blocksInput: blocksList[0],
  	task_type: kSelectionSVM_FCMA,
  	classifier: classifierList[0],
  	first_left_out_block_id:5,
  	num_items_held_for_test:0,
  	is_test_mode: 0,
  	mvpa_control: false,
  	datadir: base + 'data/',
	outputfile: base + 'top_correlation.txt',
	first_maskfile: base + 'masks/mask1.nii.gz',
	second_maskfile: base + 'masks/mask2.nii.gz',
  	blockdir: base + 'blockfiles/',
  	blockfile: base + 'blockfile.txt'
};
	
var changeNotifier = function (element, index, array) {
    element.onFinishChange(function(value) {
  		// Fires when a controller loses focus.
  		createFCMA();
		this.updateDisplay();
		console.log(this.property);
	});
}

window.onload = function() {
  var ctrlArray = new Array;
  ctrlArray.push( gui.add(params, 'analysisStage', analysisList).name('Analysis stage') );

  var blf = gui.addFolder('Blocks to leave out for cross-validation (accuracy prediction stage only)');
  ctrlArray.push( blf.add(params, 'first_left_out_block_id').min(0).max(20).step(1).name('Beginning block ID') );
  ctrlArray.push( blf.add(params, 'num_items_held_for_test').min(0).max(20).step(1).name('Number of blocks (0 to disable)') );
  
  var mf = gui.addFolder('Cluster Files & Directories');  
  ctrlArray.push( mf.add(params, 'datadir').name('Data directory') );
  ctrlArray.push( mf.add(params, 'outputfile').name('Output file') );

  var blockF = mf.addFolder('Time-series Blocks');
  ctrlArray.push( blockF.add(params,'blocksInput', blocksList).name('Blocks input') );
  ctrlArray.push( blockF.add(params,'blockdir').name('Blocks directory') );
  ctrlArray.push( blockF.add(params,'blockfile').name('Blocks file') );

  var maskF = mf.addFolder('Voxel Mask(s)');
  ctrlArray.push( maskF.add(params,'maskInput', maskList).name('Mask input') );
  ctrlArray.push( maskF.add(params,'first_maskfile').name('ROI Mask 1') );
  ctrlArray.push( maskF.add(params,'second_maskfile').name('ROI Mask 2') );

  ctrlArray.push( gui.add(params, 'classifier', classifierList ).name('Classifier') );
  ctrlArray.push( gui.add(params, 'mvpa_control').name('MVPA control condition') );
  
  mf.open();
  blockF.open();
  maskF.open();
  blf.open();
  
  ctrlArray.forEach(changeNotifier);
  
  var s = document.getElementById("setup");
  s.appendChild(gui.domElement);
  
  createFCMA();

 // gui.remember(params);
};

</script>

<!-- need to reset bootstrap settings, or they override dat gui's -->
<style type="text/css">
input[type="text"], input[type=checkbox], select {font-size:11px;width:auto;height:auto;margin-bottom:9px;}
textarea {width:auto;}
</style>

</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="http://rondo.pni.princeton.edu/fcma/">FCMA Toolbox</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a href="/fcma/">Using</a></li>
                    <li class="active"><a href="/fcma/config">FCMA File</a>
                   	<li><a href="/fcma/cluster">Cluster</a></li>
                   	<li><a href="/fcma/demo">Demo</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="page-header">
    <h2>FCMA File Generator</h2>
    </div>
	<blockquote>
		<p>Here you can generate an FCMA file, which can be used on the cluster to run the FCMA Toolbox (see main page on <a href="/fcma/">Using FCMA</a> for details)</p><br>
		<p>Set your desired FCMA parameters on the left, and the corresponding FCMA file will be automatically generated on the right in response to your changes. You can then  use either copy & paste or download to create an FCMA file (and rename it to something like <code>myparams.fcma</code>.) You will need to create two .fcma files, one for the voxel selection phase and, after you have selected the top-k voxels and produced NiFTI masks for them, one for the accuracy prediction phase. Consult the <a href="#reference">reference</a> below for more information.</p><br><br>
	</blockquote>

	<div style="min-width:900px;min-height:500px">
		<div id="setup" style="width:60%;float:left;">
		</div>
	
		<div id="fcma-file" style="width:40%;float:right;">
			<h3>Corresponding FCMA File:</h3>
			<textarea id="fcma-out" rows="20" cols="60" readonly>
			</textarea>
	
			<a href="#" class="myButton" onClick="downloadFCMA()">Download</a>	
		</div>
	</div>
	
	<div id="ref">
	<a name="reference"></a>
	<h3>Reference</h3>
		<div class="well">
		<strong>Analysis stage:</strong> The first stage, <em>voxel selection</em>, does most of the heavy lifting. It computes correlation matrices for every block so is the most compute-intensive stage. The result is a sorted list of voxels, in decreasing order of predictive power assessed by an SVM classifier during training. The second stage, <em>testing predictive accuracy</em> tests the voxels from stage 1 via maskfile(s) which must be constructed from stage 1 results (the mask construction step bridging stages 1 & 2 will be incorporated into the toolbox asap.)<br>
		<strong>Blocks held back for cross-validation:</strong> When testing prediction accuracy (stage 2) one can leave out a contiguous set of blocks from the test procedure by specifying the start block ID (where 0 is the first block appearing in the data) together with the number of blocks in the contiguous set.<br>
		<strong>Blocks directory/file:</strong> If the same blocks apply to all data files, a single file can be used. <strong><em>If using a blockfile directory, there must be 1:1 correspondence between blocks:data files</strong></em>. The filenames must differ only by file extension (Nifti compressed <code>.nii.gz</code> vs plaintext <code>.txt</code>)<br>
		<br>
		<em><strong>Blockfile format</strong></em><br>A blockfile starts with the number of blocks on the first line, followed by as many lines. On each line is the label (0 or 1), the start TR, and the ending TR number in the run.
		<br>
		<pre>
N
Label StartTR EndTR
... N rows total ...
Label StartTR EndTR</pre>
		<strong>Data directory:</strong> All files in the data directory are loaded. The number of subjects is set equal to the number of files found. Currently only Nifti compressed (<code>.nii.gz</code> extension) is recognized.<br>
		<strong>Voxel masks:</strong> Zero, one, or two masks can be specified; if two, then voxels are correlated between regions. If one, then voxels within a region are auto-correlated. No masks will result in all voxels being auto-correlated, not recommended due to the high demand it places on computing resources. Voxel masks must be in Nifti compressed (<code>.nii.gz</code>) format as well.<br>
		<strong>Output file:</strong> The output file currently is specific to the first stage, and is the sorted voxel order according to decreasing predictive performance. This file should be used as the basis for constructing the Nifti-formatted masks for the testing stage. The output of prediction accuracy in the second stage is currently written to standard out and must be parsed from the job log files. This inconvenience will be fixed in the next update to the toolbox; for a script that will do the work please contact us (see home page for contact info).<br>
		<strong>Classifier:</strong> While <em>SVM prediction</em> should be used, some experimental alternatives are available. Both <em>smart distance ratio</em> and <em>correlation sum</em> are quick to compute though accuracy will be lower. Note that if the <em>MVPA control condition</em> is checked (up next), this setting is ignored and a <em>searchlight + svm</em> selection + classifier will be used.<br><br>
		<strong><em>Note: SVM is the default classifier; only binary classification (0/1) is currently supported in the toolbox as a result</em></strong><br>Multiple classes are not hard to add, however, using the standard methods for extending SVM to handle multiple classes (one-to-all, one-to-one). However the computation time would likely grow substantially.<br><br>
		<strong>MVPA control condition:</strong> Assessing the advantage of using correlation patterns vs activation patterns can be explored by running a simple variant of MVPA hardcoded to use searchlight feature selection and SVM performance assessment.<br>
		</div>
	</div>
</div>
</body>
</html>