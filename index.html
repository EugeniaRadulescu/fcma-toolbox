<!DOCTYPE HTML>
<!--
/*
 * Full Correlation Matrix Analysis (FCMA) Toolbox
 */
-->
<html lang="en">
<head>
<!-- Force latest IE rendering engine or ChromeFrame if installed -->
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><![endif]-->
<meta charset="utf-8">
<title>Princeton FCMA Toolbox</title>
<meta name="description" content="The Princeton Full Correlation Matrix Analysis (FCMA) Toolbox is a suite of tools for correlating, analyzing, and classifying patterns of correlation in functional neuroimaging datasets.">
<meta name="viewport" content="width=device-width">
<!-- Bootstrap CSS Toolkit styles -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<!-- Generic page styles -->
<link rel="stylesheet" href="css/style.css">
<!-- Bootstrap styles for responsive website layout, supporting different screen sizes -->
<link rel="stylesheet" href="css/bootstrap-responsive.min.css">
<!-- Bootstrap CSS fixes for IE6 -->
<!--[if lt IE 7]><link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap-ie6.min.css"><![endif]-->
<!--[if lt IE 7]><link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap-ie6.min.css"><![endif]-->
<!-- Shim to make HTML5 elements usable in older Internet Explorer versions -->
<!--[if lt IE 9]><script src="js/html5.js"></script><![endif]-->
</head>
<body>
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</a>
				<a class="brand" href=".">FCMA Toolbox</a>
				<div class="nav-collapse">
					<ul class="nav">
						<li class="active"><a href="#using">Using</a></li>
						<li><a href="config">FCMA File</a>
						<li><a href="cluster">Cluster</a></li>
						<li><a href="demo">Demo</a></li>
						<li><a href="http://github.com/princetonuniversity/fcma-toolbox">Source</a></li>
						<li><a href="thanks">Thanks</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<div class="container">
		<div class="page-header">
			<h1>The Princeton FCMA Toolbox</h1>
		</div>
		<blockquote>
			<p>The Princeton Full Correlation Matrix Analysis (FCMA) Toolbox is a suite of tools for correlating, analyzing, and classifying patterns of correlation in fMRI time-series data.</p><br>
			<p>The key data structure in FCMA is the Full Correlation Matrix (FCM), which contains the correlations between all pairs of voxels and time-intervals. Computing the entire FCM is intractable: the FCM for two one-hour fMRI sessions requires approx. 1.5 x 10<sup>19</sup> correlations, nearly 20 years of compute time on a 4000-core computer cluster. The FCMA Toolbox correlates a given set of fixed time-intervals (blocks of TRs you specify) which together with some custom optimizations reduces the computational load to a matter of hours. A modest-sized cluster is still required to do the calculation. For that reason, a new toolbox was developed in the spirit of the Princeton <a href="http://code.google.com/p/princeton-mvpa-toolbox/">MVPA Toolbox</a> for Matlab, but is written in C++, OpenMP, and OpenMPI for greater performance and scalability.</p><br>
			<p>Here are the steps for running an FCMA analysis from a user perspective, including how to create an .fcma config file, without discussing the config settings in detail. Please follow the FCMA Tutorial (link TBA) for a discussion in the context of a real analysis. As far as how to install FCMA and set up a machine or cluster of machines, system administrators should consult the <a href="cluster">cluster</a> page.</p><br>
		</blockquote>
		<div class="well">
			<a name="using"></a>
			<h3>Using FCMA</h3>
			<ul>
				<li><h4>Generate an FCMA file for voxel selection</h4>
				The FCMA program input parameters are provided via a configuration file with the ".fcma" extension (see <a href="config/#reference">description of the key parameters</a>.) You can create an .fcma file:
				<ol>
					<li><strong>Online</strong>: Run the <a href="config">FCMA File Generator</a> to generate one online </li>
					<br>
					<strong><em>OR</em></strong>
					<br><br>
					<li><strong>Text editor</strong>:Edit the FCMA file directly. Some templates with lots of comments and minimal templates without:
						<ol>
							<br>
							<li><a href="template.fcma">FCMA Voxel Selection Template</a>, and</li>
							<br>
							<li><a href="template_testing.fcma">FCMA Prediction Testing Template</a></li>
							<br>
							<li><a href="template_minimal.fcma">Leave-one-subject-out Minimal Template: Selection</a></li>
							<br>
							<li><a href="template_minimal_testing.fcma">Leave-on-subject-out Minimal Template: Testing</a></li>
							<br>
							<br>
							<br>
						</ol>
						These are for the first and second phase of the analysis, respectively (described below.) The templates contains lines of instructions above each parameter setting, in the comments. The process starts with getting an fcma file:
						<pre>cp [Downloads folder]/template.fcma [Analysis folder]/myparams.fcma</pre>
						<br>
						(at the PNI, these templates are available in /opt/pni/doc/template*). You can edit the file with your favorite text <code>$EDITOR</code>:
						<pre>$EDITOR myparams.fcma </pre> 						
					</li>
				</ol>
				<br><br>
				<li><h4>Copy your FCMA file to your FCMA analysis directory</h4>
				Your analysis directory is usually where your data files and masks reside, on a machine (or set of machines) that are set up to run MPI programs. If you have an account on a compute cluster:
					<pre>scp myparams.fcma user@server:</pre>
				This will copy the file to your home directory. Once you've logged in you can move it into your analysis directory (which might not be accessible from the login node. On the PNI cluster you must start up an interactive qrsh session first to get access to lab directories where data resides.) If you use the <a href="config">generator</a> you have the option of copying the generated file contents directly into your editor window.
				</li><br>
				<em>PNI Users: please use high-performance scratch space for your analysis (/fastscratch as of fall 2013.)</em>
				<li><h4>Run FCMA voxel selection</h4>
				Once you have your .fcma file transferred and you are in your analysis directory where data is easily accessible and loaded, the <em>pni_fcma_submit</em> bash script will parse your .fcma file into command-line arguments for the <em>pni_fcma</em> compiled MPI program:
						<pre>pni_fcma_submit myparams.fcma </pre>
				</li><br>
				<li><h4>Monitor progress including estimated run time</h4>
				Voxel selection is the most time-consuming step, and you'll want to get an estimate of the running time. The <em>pni_fcma</em> program will print out timing information so you can get a sense of how long the analysis will take. At the start it will write out the number of tasks required, and each task will report its run time in seconds upon completion. Multiply the run time reported (once it has settled) by the number of tasks to get an estimate of the run time. Note that this output may be to a file if the job was submitted to a cluster resource management system. In that case you can "tail -f" the output to get live updates:
					<pre>tail -f myparams.oJOBID</pre> 
				where JOBID is the job number associated with your job (printed to console; you can also look for the file most recently updated in your current directory.) This example is for an SGE-based cluster like the PNI's. You can check the status of the job via the scheduler command:
					<pre>qstat -t</pre>
				If something is horribly wrong you can delete the job (which will also kill all the related subtasks) via:
					<pre>qdel JOBID</pre>
				</li><br>
				<li><h4>Make mask(s) for top k voxels</h4>
				The output of the first FCMA run will give you all voxels in order of their predictive performance (using SVM). Choose the top k voxels (where k below 2000 is typically sufficient) using the voxel ordering file ("_seq.nii.gz" suffix output) or via a threshold on the voxels scores ("_score.nii.gz" suffix output file).
				</li><br>
				<li><h4>Create an FCMA file to test accuracy and repeat</h4>
				This time, choose "2 - Testing predictive accuracy" (if using the <a href="config">FCMA File Generator</a>), or edit the <a href="template_testing.fcma">testing template</a> file, and run a second time. The testing phase does not require multiple tasks, but uses the same MPI-based <em>pni_fcma</em> program and submission mechanism: <code>pni_fcma_submit mytestingparams.fcma</code> .
				</li>
			</ul>
		</div>
		<br>
		<div class="well">
			<a name="notes"></a>
			<h3>Notes</h3>
			<ul>
				<li>Code by <a href="http://www.cs.princeton.edu/~yidawang/">Yida Wang</a> and <a href="http://princeton.edu/~bdsinger/">Ben Singer</a>, as part of research being carried out at the <a href="http://www.pni.princeton.edu/">Princeton Neuroscience Institute</a> in the <a href="http://www.princeton.edu/ntblab/">Turk-Browne</a>, <a href="http://www.cs.princeton.edu/~li/">Li</a>, and <a href="http://www.pni.princeton.edu/ncc/">Cohen</a> labs.</li>
				<li>Some background on the computational challenge of this project are provided by web pages that predate this one: <a href="http://qed.princeton.edu/main/The_Correlation_Project/Pyne_Fund_Proposal">Pyne Fund</a> proposal from 2010, and <a href="http://fullcorr.wikidot.com">fullcorr wiki</a>
			</ul>
		</div>
		<br>
		<div class="well">
			<a name="refs"></a>
			<h3>References</h3>
			<ul>
				<li>Wang, Y., Cohen, J. D., Li, K., & Turk-Browne, N. B. (submitted). <em>Full correlation matrix analysis (FCMA): A high-performance toolbox and case study for unbiased functional connectivity in human brain imaging.</em></li>
				<li>Wang, Y., Li, K., Charikar, M., Cohen, J. D., & Turk-Browne, N. B. (May, 2013). <a href="http://www.journalofvision.org/content/13/9/493.short">What you find depends on how you look: Category selectivity in frontal cortex revealed by whole-brain correlation analysis.</a>. Poster presented at Vision Sciences Society, Naples, FL.</li>
				<li>Turk-Browne, N. B., Li, K., Charikar, M., Cohen, J. D., & Singer, B.D. (2010). <a href="http://qed.princeton.edu/main/The_Correlation_Project/Pyne_Fund_Proposal">Computing and Mining the Full Correlation Matrix of Human Brain Imaging (fMRI) Datasets</a>. J. Insley Blair Pyne Fund Proposal (funded)
		</div>
		<br>
		<div class="well">
			<a name="help"></a>
			<h3>Getting Help</h3>
			<ul>
				<li>Please contact <a href="http://www.cs.princeton.edu/~yidawang/">Yida Wang</a> or <a href="http://princeton.edu/~bdsinger/">Ben Singer</a></li>
			</ul>
		</div>
	</div>
</body> 
</html>
